# 可执行文件的装载与进程

## 从操作系统角度看可执行文件的装载

### 进程的建立

创建一个进程，然后装载相应的可执行文件并且执行。在有虚拟存储的情况下，上述过程最开始只需要做三件事情：

- 创建一个独立的虚拟地址空间。
- 读取可执行文件头，并且建立虚拟空间与可执行文件的映射关系。
- 将 CPU 的指令寄存器设置成可执行文件的入口地址，启动运行。

## 进程虚存空间分布

操作系统只关心一些跟装载相关的问题，最主要的是段的权限（可读、可写、可执行）。ELF 文件中，段的权限往往只有为数不多的几种组合，基本上是三种：

- 以代码段为代表的权限为可读可执行的段。
- 以数据段和 BSS 段为代表的权限为可读可写的段。
- 以只读数据为代表的权限为只读的段。

那么可以找到一个很简单的方案就是：**对于相同权限的段，把它们合并到一起当作一个段进行映射**。

操作系统通过给进程空间划分出一个个 VMA 来管理进程的虚拟空间；基本原则是将相同权限属性的、有相同映像文件的映射成一个 VMA；一个进程基本上可以分为如下几种 VMA 区域：

- 代码 VMA，权限只读、可执行；有映像文件。
- 数据 VMA，权限可读写、可执行；有映像文件。
- 堆 VMA，权限可读写、可执行；无映像文件，匿名，可向上扩展。
- 栈 VMA，权限可读写、不可执行；无映像文件，匿名，可向下扩展。
