# 静态链接

## 空间与地址分配

对于多个输入目标文件，链接器如何将它们的各个段合并到输出文件？或者说，输出文件中的空间如何分配给输入文件？

**相似段合并**：将相同性质的段合并到一起，比如将所有输入文件的 “.text” 合并到输出文件的 “.text” 段，接着是 “.data” 段、“.bss” 段等。

**两步链接（Two-pass Linking）**：

1. **第一步 空间与地址分配**  扫描所有的输入目标文件，获得它们的各个段的长度、属性和位置，并且将输入目标文件中的符号表中所有的符号定义和符号引用收集起来，统一放到一个全局符号表。
2. **第二步 符号解析与重定位**  使用上面第一步中收集到的所有信息，读取输入文件中段的数据、重定位信息，并且进行符号解析与重定位、调整代码中的地址等。

## C++ 相关问题

ELF 文件还定义了两种特殊的段。

- **.init**  该段里面保存的是可执行指令，它构成了进程的初始化代码。因此，当一个程序开始运行时，在 `main` 函数被调用之前，Glibc 的初始化部分安排执行这个段中的代码。
- **.fini**  该段保存着进程终止代码指令。因此，当一个程序的 `main` 函数正常退出时，Glibc 会安排执行这个段中的代码。

### C++ 与 ABI

符号修饰标准、变量内存布局、函数调用方式等这些跟可执行代码二进制兼容性相关的内容称为 **ABI（Application Binary Interface）**。