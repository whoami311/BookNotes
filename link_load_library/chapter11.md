# 运行库

## 入口函数和程序初始化

程序的**入口点（Entry Point）**实际上是一个程序的初始化和结束部分，它往往是运行库的一部分。一个典型的程序运行步骤大致如下：

- 操作系统在创建进程后，把控制权交到了程序的入口，这个入口往往是运行库中的某个入口函数。
- 入口函数对运行库和程序运行环境进行初始化，包括堆、I/O、线程、全局变量构造，等等。
- 入口函数在完成初始化之后，调用 `main` 函数，正式开始执行程序主体部分。
- `main` 函数执行完毕以后，返回到入口函数，入口函数进行清理工作，包括全局变量析构、堆销毁、关闭 I/O 等，然后进行系统调用结束进程。

### 运行库与 IO

在操作系统层面上，文件操作也有类似于 FILE 的一个概念，在 Linux 里，这叫做**文件描述符（File Descriptor）**。用户通过某个函数打开文件以获得句柄，此后用户操作文件皆通过该句柄进行。

设计这么一个句柄的原因在于句柄可以防止用户随意读写操作系统内核的文件对象。无论是 Linux 还是 Windows，文件句柄总是和内核的文件对象相关联的，但如何关联细节用户并不可见。内核可以通过句柄来计算出内核里文件对象的地址，但此能力并不对用户开放。

### C 语言运行时库

一个 C 语言运行时库大致包含了如下功能：

- 启动与退出：包括入口函数及入口函数所依赖的其他函数等。
- 标准函数：由 C 语言标准规定的 C 语言标准库所拥有的函数实现。
- I/O：I/O 功能的封装和实现。
- 堆：堆的封装和实现。
- 语言实现：语言中一些特殊功能的实现。
- 调试：实现调试功能的代码。

### 缓冲

C 语言标准库提供与缓冲相关的几个基本函数。

| `int fflush(File *stream)` | flush 指定文件的缓冲，若参数为 `NULL`，则 flush 所有的缓冲 |
| - | - |
| `int setvbuf(FILE *stream, char *buf, int mode, size_t size)`| 设置指定文件的缓冲 |
| `void setbuf(FILE *stream, char *buf)` | 设置文件的缓冲，等价于`(void)setvbuf(stream, buf, _IOFBF, BUFSIZ)` |

## `fread` 实现

`fread` -> `fread_s`（增加缓冲溢出保护） -> `_fread_nolock_s`（循环读取、缓冲） -> `_read`（换行符转换） -> `ReadFile`（Windows 文件读取 API）
