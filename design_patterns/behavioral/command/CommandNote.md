# Command

## 意图

将一个请求封装为一个对象，从而使你可用不同的请求对客户进行参数化，对请求排队或记录请求日志，以及支持可撤销的操作。

## 动机

有时必须向某对象提交请求，但并不知道关于被请求的操作或请求的接收者的任何信息。

命令模式通过将请求本身变成一个对象来使工具箱对象可向未指定的应用对象提出请求。这个对象可被存储并像其他对象一样被传递。这一模式的关键是一个抽象的Command类，它定义了一个执行操作的接口。其最简单的形式是一个抽象的Execute操作。具体的Command子类将接收者作为它的一个实例变量，并实现Execute操作，指定接收者采取的动作。而接收者有执行该请求所需的具体信息。

## 适用性

- 抽象出待执行的动作以参数化某对象。你可用过程语言中的回调（callback）函数表达这种参数化机制。所谓回调函数是指函数先在某处注册，而它将在稍后某个需要的时候被调用。Command模式是回调机制的一个面向对象的替代品。
- 在不同的时刻指定、排列和执行请求。一个Command对象可以有一个与初始请求无关的生存期。如果一个请求的接收者可用一种与地址空间无关的方式表达，那么就可将负责该请求的命令对象传送给另一个不同的进程并在那里实现该请求。
- 支持取消操作。Command的Excute操作可在实施操作前将状态存储起来，在取消操作时这个状态用来消除该操作的影响。Command接口必须添加一个Unexecute操作，该操作取消上一次Execute调用的效果。执行的命令被存储在一个历史列表中。可通过向后或向前遍历这一列表并分别调用Unexecute和Execute来实现重数不限的“撤销”和“重做”。
- 支持修改日志，这样当系统崩溃时，这些修改可以被重做一遍。在Command接口中添加装载操作和存储操作，可以用来保持一个一致的修改日志。从崩溃中恢复的过程包括从磁盘中重新读入记录下来的命令并用Execute操作重新执行它们。
- 用构建在原语操作上的高层操作构造一个系统。这样一种结构在支持事务（transaction）的信息系统中很常见。一个事务封装了对数据的一组变动。Command模式提供了对事务进行建模的方法。Command有一个公共的接口，使得你可以用同一种方式调用所有的事务。同时使用该模式也易于添加新事务以扩展系统。

## 结构

![Command](Command.png)

## 参与者

- Command

—— 声明执行操作的接口。

- ConcreteCommand（PasteCommand、OpenCommand）

—— 将一个接收者对象绑定于一个动作。
—— 调用接收者相应的操作，以实现Execute。

- Client（Application）

—— 创建一个具体命令对象并设定它的接收者。

- Invoker（MenuItem）

—— 要求该命令执行这个请求。

- Receiver（Document、Application）

—— 知道如何实施与执行一个请求相关的操作。任何类都可能作为一个接收者。

## 协作

- Client创建一个ConcreteCommand对象并指定它的Receiver对象。
- 某Invoker对象存储该ConcreteCommand对象。
- 该Invoker通过调用Command对象的Execute操作来提交一个请求。若该命令是可撤销的，ConcreteCommand就在执行Execute操作之前存储当前状态以用于取消该命令。
- ConcreteCommand对象调用它的Receiver的一些操作以执行该请求。

下图展示了这些对象之间的交互。它说明了Command是如何将调用者和接收者（以及它执行的请求）解耦的。

![CommandInteraction](CommandInteraction.png)

## 效果

1. Command模式将调用操作的对象与知道如何实现该操作的对象解耦。
2. Command是头等的对象。它们可像其他的对象一样被操纵和扩展。
3. 你可将多个命令装配成一个组合命令。一般说来，组合命令是Composite模式的一个实例。
4. 增加新的Command很容易，因为这无须改变已有的类。

## 实现

1. 一个命令对象应达到何种智能程度
2. 支持撤销（undo）和重做（redo）

>为达到这个目的，ConcreteCommand类可能需要存储额外的状态信息。这个状态包括：
>- 接收者对象，它真正执行处理该请求的各操作。
>- 接收者执行的操作的参数。
>- 如果处理请求的操作会改变接收者对象中的某些值，那么这些值也必须先存储起来。接收者还必须提供一些操作，以使该命令可将接收者恢复到它先前的状态。

3. 避免撤销操作过程中的错误积累
4. 使用C++模板

## 相关模式

Composite可用来实现宏命令。

Memento可用来保持这个状态，命令用这一状态来取消它的效果。

在被放入历史列表前必须被拷贝的命令起到一种原型的作用。
