# chapter5

1. I/O复用典型使用在下列应用场合。

- 当客户处理多个描述符时，必须使用I/O复用。
- 一个客户同时处理多个套接字。
- 如果一个ICP服务器既要处理监听套接字，又要处理已连接套接字，一般就要使用I/O复用。
- 如果一个服务器既要处理TCP，又要处理UDP，一般就要使用I/O复用。
- 如果一个服务器要处理多个服务或者多个协议，一般就要使用I/O复用。

2. I/O模型：

- 阻塞式I/O（默认）
- 非阻塞式I/O（立即返回错误 + 轮询）
- I/O复用（阻塞于select和poll）
- 信号驱动式I/O（就绪时发送SIGIO）
- 异步I/O（完成后通知，aio_或lio_开头函数，不成熟）

3. 基于不同内核下被中断的select有可能自动重启。从可移植性考虑，如果我们在捕获信号，那么必须做好select返回EINTR错误的准备。
4. 有些linux版本会修改select的timeval结构。因此从移植性考虑，每次调用select之前都得对它进行初始化。
5. 使用select时最常见的两个编程错误是：忘了对最大描述符加1；忘了描述符集是值-结果参数。

6. 描述符就绪条件：
(1)一个套接字准备好读：
a)该套接字接收缓冲区中的数据字节数大于等于套接字接收缓冲区低水位标记的当前大小。对这样的套接字执行读操作不会阻塞并将返回一个大于0的值（也就是返回准备好读入的数据）。我们可以使用SO_RCVLOWAT套接字选项设置该套接字的低水位标记。对于TCP和UDP套接字而言，其默认值为1。
b)该连接的读半部关闭（也就是接收了FIN的TCP连接）。对这样的套接字的读操作将不阻塞并返回0（也就是返回EOF）。
c)该套接字是一个监听套接字且已完成的连接数不为0。对这样的套接字的accept通常不会阻塞。
d)其上有一个套接字错误待处理。对这样的套接字的读操作将不阻塞并返回-1，同时把errno设置成确切的错误条件。这些待处理错误（pending error）也可以通过指定SO_ERROR套接字选项调用getsockopt获取并清除。
(2)一个套接字准备好写：
a)该套接字发送缓冲区中的可用空间字节数大于等于套接字发送缓冲区低水位标记的当前大小，并且或者该套接字已连接，或者该套接字不需要连接（如UDP套接字）。这意味着如果我们把这样的套接字设置成非阻塞，写操作将不阻塞并返回一个正值（如由传输层接收的字节数）。我们可以使用SO_SNDLOWWT套接字选项来设置该套接字的低水位标记。对于TCP和UDP套接字而言，其默认值通常为2048。
b)该连接的写半部关闭。对这样的套接字的写操作将产生SIGPIPE信号。
c)使用非阻塞式connect的套接字已建立连接，或者connect已经以失败告终。
d)其上有一个套接字错误待处理。对这样的套接字的写操作将不阻塞并返回-1，同时把errno设置成确切的错误条件。这些待处理错误也可以通过指定SO_ERROR套接字选项调用getsockopt获取并清除。
(3)如果一个套接字存在带外数据或者仍处于带外标记，那么它有异常条件待处理。

7. 接收低水位标记和发送低水位标记的目的在于：允许应用进程控制在select返回可读或可写条件之前有多少数据可读或有多大空间可用于写。例如，如果我们知道除非至少存在64字节的数据，否则我们的应用进程没有任何有效工作可做，那么可以把接收低水位标记设置为64，以防少于64字节的数据准备好读时select唤醒我们。任何UDP套接字只要其发送低水位标记小于等于发送缓冲区大小（默认应该总是这种关系）就总是可写的，这是因为UDP不需要连接。
8. 一般地说，为提升性能而引入缓冲机制增加了网络应用程序的复杂性。select不知道stdio使用了缓冲区————它只是从read系统调用的角度指出是否有数据可读，而不是从fgets之类调用的角度考虑。因此，混合使用stdio和select被认为是非常容易犯错误的，在这样做时必须极其小心。
9. 终止网络连接的通常方法是调用close函数。不过close有两个限制，却可以使用shutdown来避免。
(1)close把描述符的引用计数减1，仅在改计数变为0时才关闭套接字。使用shutdown可以不管引用计数就激发TCP的正常连接终止序列。
(2)close终止读和写两个方向的数据传送。shutdown可以关闭连接的读半部或写半部。
10. 拒绝服务（denial of service）型攻击的解决方法：(a)使用非阻塞式I/O；(b)让每个客户由单独的控制线程提供服务（如创建一个子进程或一个线程来服务每个客户）；(c)对I/O操作设置一个超时。
11. pselect相对于select有两个变化。(1)pselect使用timespec结构，而不使用timeval结构。(2)pselect函数增加了第六个参数：一个指向信号掩码的指针。该参数允许程序先禁止递交某些信号，再测试由这些当前被禁止信号的信号处理函数设置的全局变量，然后调用pselect，告诉它重新设置信号掩码。
12. poll无最大描述符数目限制：分配一个pollfd结构的数组并把该数组中元素的数目通知内核成了调用者的责任，内核不再需要知道类似fd_set的固定大小的数据类型。